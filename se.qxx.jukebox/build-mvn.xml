<?xml version="1.0" encoding="ISO-8859-1"?>
<project>
    
   	<target name="createscript">
	    <echo file="${script.file}"><![CDATA[#!/bin/sh
if [ -n "$LD_LIBRARY_PATH" ]
then
   LD_LIBRARY_PATH=$PWD:${LD_LIBRARY_PATH}
else
   LD_LIBRARY_PATH=$PWD
fi
export LD_LIBRARY_PATH=$LD_LIBRARY_PATH]]>
</echo>

	    <echo file="${script.file}" message="java -Xmx1024m -${run.type} 
${jarFile} ${script.class} ${1+&quot;$@&quot;} &amp;${line.separator}" 
	        append="true" />		

		<chmod file="${script.file}" perm="755" />
	</target>
	
	<target name="createrunscript">
		<echo message="Project directory :: ${build.dir}" />

	    <antcall target="createscript">
	        <param name="script.class" value="" />	        
	        <param name="script.file" value="${build.dir}/run.sh" />
	        <param name="run.type" value="jar" />
	    </antcall>
	    <echo file="${build.dir}/run.sh" append="true">echo $! > jukebox.pid</echo>

	    <for list="TestMediaInfo,TestNfoScanner,TestImdbXmlReader,TestMovieBuilder,TestImdbFinder,TestParserBuilder,GenerateDatabase,TestWebResult,TestSeriesFinder,DeleteSeries,StreamingTest,TestSubscene,TestSubsConverter,TestExtractMkv,TestSubsDir"
			delimiter=","
	        param="param.class">
			<sequential>
		    <antcall target="createscript">
		        <param name="script.class" value="se.qxx.jukebox.tests.@{param.class}" />
		        <param name="script.file" value="${build.dir}/@{param.class}.sh" />
		        <param name="run.type" value="cp" />
		    </antcall>	        
			</sequential>
	    </for>
   	    	    	    	    	    
		<fixcrlf srcdir="${build.dir}" includes="**/*.sh" eol="lf" eof="remove" />
						
		<copy file="${base.dir}/JukeboxSettings.xml" todir="${build.dir}" />
		<copy file="${base.dir}/imdb.xml" todir="${build.dir}" />
		<copy file="${base.dir}/parser.xml" todir="${build.dir}" />
		<copy file="${base.dir}/stop.sh" todir="${build.dir}" />
			
	</target>	

	<target name="bigzip">
		<basename property="jar.basename" file="${jarFile}" suffix="-jar-with-dependencies.jar" />

		<zip destfile="${build.dir}/${jar.basename}.zip">
			<fileset dir="target" includes="*.sh" />
			<fileset dir="target" includes="*.jar" />
			<fileset dir="target" includes="*.xml" />
		</zip>
	</target>
    
	<target name="deploy" if="${doDeploy}">
		<echo message="Connecting..." />
		<echo message="Server :: ${jukeboxDeployServer}" />
		<echo message="User :: ${jukeboxDeployUser}" />
		<echo message="Path :: ${jukeboxDeployPath}" />
		<echo message="KeyFile :: ${jukeboxKeyFile}" />

		<sshexec
	        trust="true"
	        keyfile="${jukeboxKeyFile}"
	        host="${jukeboxDeployServer}"
	        username="${jukeboxDeployUser}"
	        failonerror="false"
	        command="cd ${jukeboxDeployPath};./stop.sh;" 
	        passphrase="${jukeboxKeyFilePass}"
        />
	    	    
	    <sshexec
	        trust="true"
	        keyfile="${jukeboxKeyFile}"
	        host="${jukeboxDeployServer}"
	        username="${jukeboxDeployUser}"
	        failonerror="false"
	        passphrase="${jukeboxKeyFilePass}"
	        command="rm ${jukeboxDeployPath}/*.jar;rm ${jukeboxDeployPath}/*.log; rm ${jukeboxDeployPath}/*.sh"
        />
	    
			<scp  
					todir="${jukeboxDeployUser}@${jukeboxDeployServer}:${jukeboxDeployPath}" 
					trust="true"
					keyfile="${jukeboxKeyFile}"
					passphrase="${jukeboxKeyFilePass}"
				>
             	<fileset dir="${build.dir}">
               	<include name="*" />
					</fileset>
				</scp>

	    <sshexec
	        trust="true"
	        keyfile="${jukeboxKeyFile}"
	        host="${jukeboxDeployServer}"
	        username="${jukeboxDeployUser}"
	        failonerror="false"
	        passphrase="${jukeboxKeyFilePass}"
	        command="cd ${jukeboxDeployPath}; chmod 755 *.sh"
        />

	</target>
</project>
